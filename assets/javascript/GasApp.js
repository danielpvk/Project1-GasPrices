
//const apiKey = "AIzaSyAkh0c7Mz6IlrLYP10ExGH5fyY4CeztzNk";
const apiKey ="AIzaSyDxZlTe1PvD3k78gvK3djkLU4SAe64ntX8";
const url = "https://maps.googleapis.com/maps/api/geocode/json?address=";
let map;
let lat;
let long;
let zoom = 0;
let arrayDistancias = [];

navigator.geolocation.getCurrentPosition(function (position) {
    lat = position.coords.latitude;
    long = position.coords.longitude;
    console.log("Localizacion actual:(dentro de funcion) " + lat + "  ,  " + long);
})


console.log("despues de localizacion");

let origin = ["0", "0"];
//let origin = [lat, long];
console.log("Localizacion actual: " + lat + "  ,  " + long);



function initMap(zoom, inicio) {
    if (zoom == undefined || zoom == null)
        zoom = 10;
    if (inicio == undefined)
        inicio = true;
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: zoom,
        center: new google.maps.LatLng(origin[0], origin[1]),
        mapTypeId: 'roadmap'
    });

    var iconBase = 'https://maps.google.com/mapfiles/kml/shapes/';
    var icons = {
        stations: {
            name: 'Pemex',
            icon: 'icon50.png',//iconBase + 'stations_lot_maps.png'
            //origin: { x: 0, y: 0 }
        }

    };

    let features = [];
    let response = null;
    /********************************************************/
    if (!inicio) {
        $.ajax({
            url: "https://api.datos.gob.mx/v1/precio.gasolina.publico",
            method: "GET"
        }).then(function (response) {
            //console.log(response);

            for (let n = 0; n < response.results.length; n++) {

                features[n] = {
                    position: new google.maps.LatLng(response.results[n].latitude, response.results[n].longitude),
                    type: 'stations',
                    regular: response.results[n].regular,
                    premium: response.results[n].premium
                };

                arrayDistancias[n] = {
                    dist: getDistanceFromLatLonInKm(origin[0], origin[1], response.results[n].latitude, response.results[n].longitude),
                    lat: response.results[n].latitude,
                    long: response.results[n].longitude,
                    regular: response.results[n].regular,
                    premium: response.results[n].premium,
                    name: response.results[n].razonsocial
                }

            }
            //console.table(arrayDistancias);
            let nuevoArray = arrayDistancias.sort(function (a, b) {
                return a.dist - b.dist;
            })
            //console.log(nuevoArray);


            for (let n = 0; n < features.length; n++) {

                features[n] = {
                    position: new google.maps.LatLng(nuevoArray[n].lat, nuevoArray[n].long),
                    type: 'stations',
                    regular: nuevoArray[n].regular,
                    premium: nuevoArray[n].premium,
                    razonsocial: nuevoArray[n].name,
                    distance: nuevoArray[n].dist
                };
            }
            console.log(features);
            tablefill(nuevoArray);
            features.forEach(function (feature) {
                var marker = new google.maps.Marker({
                    position: feature.position,
                    icon: icons[feature.type].icon,
                    map: map,
                    //label: { color: '#E82E06', text: '$ ' + feature.regular + " / $ " + feature.premium }
                });

                var infoWindow = new google.maps.InfoWindow({

                    content: '<h4 style="color:green;"> Regular: ' + feature.regular + '</h4><h4 style="color:red;">Premium: ' +
                        feature.premium + '</h4><h4>Name: ' + feature.razonsocial + '</h4><h4>Distance: ' + feature.distance + ' Km</h4>'

                });

                marker.addListener('click', function () {
                    infoWindow.open(map, marker);
                });

                //infoWindow.open(map,marker);

            });

        });
        console.log(features);

        /*********************************************************/

    }
}

function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
    var R = 6371; // Radius of the earth in km
    var dLat = deg2rad(lat2 - lat1);  // deg2rad below
    var dLon = deg2rad(lon2 - lon1);
    var a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2)
        ;
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    var d = R * c; // Distance in km
    return Math.round(d * 100) / 100;
}


function deg2rad(deg) {
    return deg * (Math.PI / 180)
}

$("#boton").click(function (evento) {
    event.preventDefault();
    console.log("Localizacion actual: en boton " + lat + "  ,  " + long);
    origin = [lat, long];
    initMap(12, false);
    //console.log("Localizacion actual: en boton "+lat+"  ,  " + long);

})


//let postalCode = "01219";


$("#cpBtn").click(function (event) {

    const url = "https://maps.googleapis.com/maps/api/geocode/json?address=";

    postalCode = $("#cp").val().trim();
    console.log("Postal code: " + postalCode);
    event.preventDefault();

    $.ajax({
        url: url + postalCode + ",mexico&key=" + apiKey,
        method: "GET"
    }).then(function (response) {

        console.log(response);
        console.log(response.results[0].formatted_address);
        console.log("Latitud: " + response.results[0].geometry.location.lat + "  Longitud: " + response.results[0].geometry.location.lng)

        origin = [response.results[0].geometry.location.lat, response.results[0].geometry.location.lng];
        initMap(15, false);


    });




});











































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































